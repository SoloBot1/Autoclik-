--[[
    Mobile AirHub - оптимизирован под телефон
]]

--// Loaded Check
if MobileAirHubLoaded then
    return
end

getgenv().MobileAirHubLoaded = true

--// Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")
local CoreGui = game:GetService("CoreGui")

--// Variables
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera

-- Mobile-friendly config
local config = {
    -- Aimbot
    aimbotEnabled = false,
    aimbotKey = Enum.KeyCode.ButtonR2,
    fov = 80,
    smoothing = 0.3,
    teamCheck = false,
    
    -- ESP
    espEnabled = false,
    espBoxColor = Color3.fromRGB(0, 255, 0),
    espTextColor = Color3.fromRGB(255, 255, 255),
    showDistance = true,
    showHealth = true,
    
    -- FOV Ring
    fovRingVisible = true,
    fovRingColor = Color3.fromRGB(255, 255, 0),
    
    -- UI
    uiScale = 1.0
}

--// Mobile UI Library
local MobileUI = {}
MobileUI.__index = MobileUI

function MobileUI:CreateWindow(name)
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MobileAirHub"
    screenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
    screenGui.Parent = CoreGui
    
    -- Main Frame
    local mainFrame = Instance.new("Frame")
    mainFrame.Name = "MainFrame"
    mainFrame.Size = UDim2.new(0, 300, 0, 400)
    mainFrame.Position = UDim2.new(0.5, -150, 0.5, -200)
    mainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    mainFrame.BorderSizePixel = 0
    mainFrame.ClipsDescendants = true
    mainFrame.Parent = screenGui
    
    -- Corner
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = mainFrame
    
    -- Stroke
    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(80, 80, 100)
    stroke.Thickness = 2
    stroke.Parent = mainFrame
    
    -- Title Bar
    local titleBar = Instance.new("Frame")
    titleBar.Name = "TitleBar"
    titleBar.Size = UDim2.new(1, 0, 0, 40)
    titleBar.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    titleBar.BorderSizePixel = 0
    titleBar.Parent = mainFrame
    
    local titleCorner = Instance.new("UICorner")
    titleCorner.CornerRadius = UDim.new(0, 12)
    titleCorner.Parent = titleBar
    
    local titleLabel = Instance.new("TextLabel")
    titleLabel.Name = "Title"
    titleLabel.Size = UDim2.new(1, -80, 1, 0)
    titleLabel.Position = UDim2.new(0, 10, 0, 0)
    titleLabel.BackgroundTransparency = 1
    titleLabel.Text = name
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextSize = 18
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    titleLabel.Parent = titleBar
    
    -- Close Button
    local closeButton = Instance.new("TextButton")
    closeButton.Name = "CloseButton"
    closeButton.Size = UDim2.new(0, 30, 0, 30)
    closeButton.Position = UDim2.new(1, -35, 0.5, -15)
    closeButton.BackgroundColor3 = Color3.fromRGB(255, 60, 60)
    closeButton.BorderSizePixel = 0
    closeButton.Text = "X"
    closeButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    closeButton.TextSize = 16
    closeButton.Font = Enum.Font.GothamBold
    closeButton.Parent = titleBar
    
    local closeCorner = Instance.new("UICorner")
    closeCorner.CornerRadius = UDim.new(0, 6)
    closeCorner.Parent = closeButton
    
    -- Toggle Button
    local toggleButton = Instance.new("TextButton")
    toggleButton.Name = "ToggleButton"
    toggleButton.Size = UDim2.new(0, 60, 0, 30)
    toggleButton.Position = UDim2.new(0, 10, 0, 50)
    toggleButton.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    toggleButton.BorderSizePixel = 0
    toggleButton.Text = "OPEN"
    toggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    toggleButton.TextSize = 14
    toggleButton.Font = Enum.Font.Gotham
    toggleButton.Parent = screenGui
    
    local toggleCorner = Instance.new("UICorner")
    toggleCorner.CornerRadius = UDim.new(0, 8)
    toggleCorner.Parent = toggleButton
    
    -- Content Frame
    local contentFrame = Instance.new("Frame")
    contentFrame.Name = "Content"
    contentFrame.Size = UDim2.new(1, -20, 1, -60)
    contentFrame.Position = UDim2.new(0, 10, 0, 50)
    contentFrame.BackgroundTransparency = 1
    contentFrame.Parent = mainFrame
    
    -- Scrolling Frame
    local scrollFrame = Instance.new("ScrollingFrame")
    scrollFrame.Name = "ScrollFrame"
    scrollFrame.Size = UDim2.new(1, 0, 1, 0)
    scrollFrame.BackgroundTransparency = 1
    scrollFrame.BorderSizePixel = 0
    scrollFrame.ScrollBarThickness = 4
    scrollFrame.ScrollBarImageColor3 = Color3.fromRGB(100, 100, 120)
    scrollFrame.Parent = contentFrame
    
    local uiListLayout = Instance.new("UIListLayout")
    uiListLayout.Padding = UDim.new(0, 8)
    uiListLayout.Parent = scrollFrame
    
    -- Make draggable
    local dragging = false
    local dragInput, dragStart, startPos
    
    local function update(input)
        local delta = input.Position - dragStart
        mainFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end
    
    titleBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStart = input.Position
            startPos = mainFrame.Position
            
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                end
            end)
        end
    end)
    
    titleBar.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if input == dragInput and dragging then
            update(input)
        end
    end)
    
    -- Toggle visibility
    local visible = true
    
    closeButton.MouseButton1Click:Connect(function()
        screenGui:Destroy()
        MobileAirHubLoaded = false
    end)
    
    toggleButton.MouseButton1Click:Connect(function()
        visible = not visible
        mainFrame.Visible = visible
        toggleButton.Text = visible and "CLOSE" or "OPEN"
    end)
    
    local self = setmetatable({
        ScreenGui = screenGui,
        MainFrame = mainFrame,
        ScrollFrame = scrollFrame,
        ToggleButton = toggleButton
    }, MobileUI)
    
    return self
end

function MobileUI:CreateSection(name)
    local section = Instance.new("Frame")
    section.Name = "Section"
    section.Size = UDim2.new(1, 0, 0, 0)
    section.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    section.BorderSizePixel = 0
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 8)
    corner.Parent = section
    
    local sectionLabel = Instance.new("TextLabel")
    sectionLabel.Name = "Label"
    sectionLabel.Size = UDim2.new(1, -20, 0, 30)
    sectionLabel.Position = UDim2.new(0, 10, 0, 5)
    sectionLabel.BackgroundTransparency = 1
    sectionLabel.Text = name
    sectionLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    sectionLabel.TextSize = 16
    sectionLabel.Font = Enum.Font.GothamBold
    sectionLabel.TextXAlignment = Enum.TextXAlignment.Left
    sectionLabel.Parent = section
    
    local content = Instance.new("Frame")
    content.Name = "Content"
    content.Size = UDim2.new(1, -20, 0, 0)
    content.Position = UDim2.new(0, 10, 0, 40)
    content.BackgroundTransparency = 1
    content.Parent = section
    
    local listLayout = Instance.new("UIListLayout")
    listLayout.Padding = UDim.new(0, 5)
    listLayout.Parent = content
    
    section.Parent = self.ScrollFrame
    
    local function updateSize()
        section.Size = UDim2.new(1, 0, 0, 40 + content.AbsoluteContentSize.Y)
    end
    
    listLayout:GetPropertyChangedSignal("AbsoluteContentSize"):Connect(updateSize)
    updateSize()
    
    return {
        Frame = section,
        Content = content
    }
end

function MobileUI:CreateToggle(section, name, flag, default, callback)
    local toggle = Instance.new("Frame")
    toggle.Name = "Toggle"
    toggle.Size = UDim2.new(1, 0, 0, 30)
    toggle.BackgroundTransparency = 1
    
    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Size = UDim2.new(0.7, 0, 1, 0)
    label.BackgroundTransparency = 1
    label.Text = name
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 14
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = toggle
    
    local button = Instance.new("TextButton")
    button.Name = "ToggleButton"
    button.Size = UDim2.new(0, 50, 0, 25)
    button.Position = UDim2.new(1, -55, 0.5, -12)
    button.BackgroundColor3 = default and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(80, 80, 80)
    button.BorderSizePixel = 0
    button.Text = ""
    button.Parent = toggle
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 12)
    corner.Parent = button
    
    local toggleCircle = Instance.new("Frame")
    toggleCircle.Name = "Circle"
    toggleCircle.Size = UDim2.new(0, 21, 0, 21)
    toggleCircle.Position = default and UDim2.new(1, -28, 0.5, -10) or UDim2.new(0, 2, 0.5, -10)
    toggleCircle.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    toggleCircle.BorderSizePixel = 0
    toggleCircle.Parent = button
    
    local circleCorner = Instance.new("UICorner")
    circleCorner.CornerRadius = UDim.new(1, 0)
    circleCorner.Parent = toggleCircle
    
    button.MouseButton1Click:Connect(function()
        default = not default
        button.BackgroundColor3 = default and Color3.fromRGB(0, 170, 0) or Color3.fromRGB(80, 80, 80)
        
        local tweenInfo = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
        local tween = TweenService:Create(toggleCircle, tweenInfo, {
            Position = default and UDim2.new(1, -28, 0.5, -10) or UDim2.new(0, 2, 0.5, -10)
        })
        tween:Play()
        
        callback(default)
    end)
    
    toggle.Parent = section.Content
    return toggle
end

function MobileUI:CreateSlider(section, name, flag, min, max, default, callback)
    local slider = Instance.new("Frame")
    slider.Name = "Slider"
    slider.Size = UDim2.new(1, 0, 0, 50)
    slider.BackgroundTransparency = 1
    
    local label = Instance.new("TextLabel")
    label.Name = "Label"
    label.Size = UDim2.new(1, 0, 0, 20)
    label.BackgroundTransparency = 1
    label.Text = name .. ": " .. default
    label.TextColor3 = Color3.fromRGB(255, 255, 255)
    label.TextSize = 14
    label.Font = Enum.Font.Gotham
    label.TextXAlignment = Enum.TextXAlignment.Left
    label.Parent = slider
    
    local track = Instance.new("Frame")
    track.Name = "Track"
    track.Size = UDim2.new(1, 0, 0, 6)
    track.Position = UDim2.new(0, 0, 0, 30)
    track.BackgroundColor3 = Color3.fromRGB(80, 80, 80)
    track.BorderSizePixel = 0
    track.Parent = slider
    
    local trackCorner = Instance.new("UICorner")
    trackCorner.CornerRadius = UDim.new(1, 0)
    trackCorner.Parent = track
    
    local fill = Instance.new("Frame")
    fill.Name = "Fill"
    fill.Size = UDim2.new((default - min) / (max - min), 0, 1, 0)
    fill.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    fill.BorderSizePixel = 0
    fill.Parent = track
    
    local fillCorner = Instance.new("UICorner")
    fillCorner.CornerRadius = UDim.new(1, 0)
    fillCorner.Parent = fill
    
    local thumb = Instance.new("TextButton")
    thumb.Name = "Thumb"
    thumb.Size = UDim2.new(0, 20, 0, 20)
    thumb.Position = UDim2.new((default - min) / (max - min), -10, 0.5, -10)
    thumb.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
    thumb.BorderSizePixel = 0
    thumb.Text = ""
    thumb.Parent = track
    
    local thumbCorner = Instance.new("UICorner")
    thumbCorner.CornerRadius = UDim.new(1, 0)
    thumbCorner.Parent = thumb
    
    local dragging = false
    
    local function update(value)
        value = math.clamp(value, min, max)
        local percent = (value - min) / (max - min)
        
        fill.Size = UDim2.new(percent, 0, 1, 0)
        thumb.Position = UDim2.new(percent, -10, 0.5, -10)
        label.Text = name .. ": " .. math.floor(value)
        
        callback(value)
    end
    
    thumb.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
        end
    end)
    
    thumb.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            dragging = false
        end
    end)
    
    track.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.Touch then
            local percent = (input.Position.X - track.AbsolutePosition.X) / track.AbsoluteSize.X
            update(min + percent * (max - min))
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and input.UserInputType == Enum.UserInputType.Touch then
            local percent = (input.Position.X - track.AbsolutePosition.X) / track.AbsoluteSize.X
            update(min + percent * (max - min))
        end
    end)
    
    slider.Parent = section.Content
    return slider
end

function MobileUI:CreateButton(section, name, callback)
    local button = Instance.new("TextButton")
    button.Name = "Button"
    button.Size = UDim2.new(1, 0, 0, 35)
    button.BackgroundColor3 = Color3.fromRGB(60, 60, 80)
    button.BorderSizePixel = 0
    button.Text = name
    button.TextColor3 = Color3.fromRGB(255, 255, 255)
    button.TextSize = 14
    button.Font = Enum.Font.Gotham
    
    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0, 6)
    corner.Parent = button
    
    button.MouseButton1Click:Connect(callback)
    button.Parent = section.Content
    
    return button
end

--// FOV Ring
local FOVring = Drawing.new("Circle")
FOVring.Visible = config.fovRingVisible
FOVring.Thickness = 2
FOVring.Radius = config.fov
FOVring.Transparency = 1
FOVring.Color = config.fovRingColor
FOVring.Filled = false
FOVring.Position = workspace.CurrentCamera.ViewportSize / 2

--// ESP Functions
local espCache = {}

local function createESP(player)
    if player == LocalPlayer then return end
    
    local esp = {
        box = Drawing.new("Square"),
        name = Drawing.new("Text"),
        distance = Drawing.new("Text")
    }
    
    -- Box
    esp.box.Visible = false
    esp.box.Thickness = 2
    esp.box.Color = config.espBoxColor
    esp.box.Filled = false
    
    -- Name
    esp.name.Visible = false
    esp.name.Center = true
    esp.name.Outline = true
    esp.name.Size = 14
    esp.name.Color = config.espTextColor
    
    -- Distance
    esp.distance.Visible = false
    esp.distance.Center = true
    esp.distance.Outline = true
    esp.distance.Size = 12
    esp.distance.Color = config.espTextColor
    
    espCache[player] = esp
end

local function updateESP()
    for player, esp in pairs(espCache) do
        local character = player.Character
        
        esp.box.Visible = false
        esp.name.Visible = false
        esp.distance.Visible = false
        
        if character and character:FindFirstChild("Humanoid") and character:FindFirstChild("HumanoidRootPart") and character:FindFirstChild("Head") then
            local humanoid = character.Humanoid
            local rootPart = character.HumanoidRootPart
            local head = character.Head
            
            if humanoid.Health > 0 then
                local headPos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(head.Position)
                
                if onScreen then
                    local distance = (LocalPlayer.Character.HumanoidRootPart.Position - rootPart.Position).Magnitude
                    
                    -- Mobile-friendly ESP size
                    local scale = math.clamp(50 / distance, 0.5, 2.0)
                    local boxSize = Vector2.new(40 * scale, 60 * scale)
                    local boxPosition = Vector2.new(headPos.X - boxSize.X / 2, headPos.Y - boxSize.Y / 2)
                    
                    -- Box
                    esp.box.Size = boxSize
                    esp.box.Position = boxPosition
                    esp.box.Visible = config.espEnabled
                    
                    -- Name
                    esp.name.Text = player.Name
                    esp.name.Position = Vector2.new(headPos.X, boxPosition.Y - 20)
                    esp.name.Visible = config.espEnabled
                    
                    -- Distance
                    if config.showDistance then
                        esp.distance.Text = string.format("[%d]", distance)
                        esp.distance.Position = Vector2.new(headPos.X, boxPosition.Y + boxSize.Y + 10)
                        esp.distance.Visible = config.espEnabled
                    end
                end
            end
        end
    end
end

--// Aimbot Functions
local function getClosestPlayer()
    local closestPlayer = nil
    local closestDistance = config.fov
    local center = workspace.CurrentCamera.ViewportSize / 2
    
    for _, player in pairs(Players:GetPlayers()) do
        if player == LocalPlayer then continue end
        if config.teamCheck and player.Team == LocalPlayer.Team then continue end
        
        local character = player.Character
        if character and character:FindFirstChild("Humanoid") and character.Humanoid.Health > 0 and character:FindFirstChild("Head") then
            local headPos, onScreen = workspace.CurrentCamera:WorldToViewportPoint(character.Head.Position)
            
            if onScreen then
                local distance = (Vector2.new(headPos.X, headPos.Y) - center).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = player
                end
            end
        end
    end
    
    return closestPlayer
end

local function aimAt(target)
    if not target or not target.Character or not target.Character:FindFirstChild("Head") then return end
    
    local targetHead = target.Character.Head
    local camera = workspace.CurrentCamera
    
    local currentCFrame = camera.CFrame
    local targetPosition = targetHead.Position
    
    local newCFrame = CFrame.new(camera.CFrame.Position, targetPosition)
    camera.CFrame = currentCFrame:Lerp(newCFrame, config.smoothing)
end

--// Main Loops
RunService.RenderStepped:Connect(function()
    -- FOV Ring
    FOVring.Radius = config.fov
    FOVring.Visible = config.fovRingVisible
    FOVring.Position = workspace.CurrentCamera.ViewportSize / 2
    
    -- Aimbot
    if config.aimbotEnabled and UserInputService:IsKeyDown(config.aimbotKey) then
        local target = getClosestPlayer()
        if target then
            aimAt(target)
        end
    end
    
    -- ESP
    if config.espEnabled then
        updateESP()
    end
end)

--// Initialize Mobile UI
local MobileWindow = MobileUI:CreateWindow("Mobile AirHub")

-- General Section
local generalSection = MobileWindow:CreateSection("General")

MobileWindow:CreateToggle(generalSection, "Aimbot", "AimbotEnabled", config.aimbotEnabled, function(value)
    config.aimbotEnabled = value
end)

MobileWindow:CreateToggle(generalSection, "ESP", "ESPEnabled", config.espEnabled, function(value)
    config.espEnabled = value
    if not value then
        for _, esp in pairs(espCache) do
            esp.box.Visible = false
            esp.name.Visible = false
            esp.distance.Visible = false
        end
    end
end)

MobileWindow:CreateToggle(generalSection, "Team Check", "TeamCheck", config.teamCheck, function(value)
    config.teamCheck = value
end)

-- Aimbot Section
local aimbotSection = MobileWindow:CreateSection("Aimbot Settings")

MobileWindow:CreateSlider(aimbotSection, "FOV Size", "FOVSize", 10, 200, config.fov, function(value)
    config.fov = value
end)

MobileWindow:CreateSlider(aimbotSection, "Smoothing", "Smoothing", 0.1, 1.0, config.smoothing, function(value)
    config.smoothing = value
end)

MobileWindow:CreateToggle(aimbotSection, "FOV Ring", "FOVRing", config.fovRingVisible, function(value)
    config.fovRingVisible = value
end)

-- ESP Section
local espSection = MobileWindow:CreateSection("ESP Settings")

MobileWindow:CreateToggle(espSection, "Show Distance", "ShowDistance", config.showDistance, function(value)
    config.showDistance = value
end)

MobileWindow:CreateToggle(espSection, "Show Health", "ShowHealth", config.showHealth, function(value)
    config.showHealth = value
end)

-- Utilities Section
local utilsSection = MobileWindow:CreateSection("Utilities")

MobileWindow:CreateButton(utilsSection, "Refresh ESP", function()
    for _, esp in pairs(espCache) do
        esp.box:Remove()
        esp.name:Remove()
        esp.distance:Remove()
    end
    espCache = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        createESP(player)
    end
end)

MobileWindow:CreateButton(utilsSection, "Hide UI", function()
    MobileWindow.MainFrame.Visible = false
    MobileWindow.ToggleButton.Text = "OPEN"
end)

-- Initialize ESP for all players
for _, player in pairs(Players:GetPlayers()) do
    createESP(player)
end

Players.PlayerAdded:Connect(function(player)
    createESP(player)
end)

Players.PlayerRemoving:Connect(function(player)
    if espCache[player] then
        espCache[player].box:Remove()
        espCache[player].name:Remove()
        espCache[player].distance:Remove()
        espCache[player] = nil
    end
end)

-- Auto-adjust for mobile
spawn(function()
    while wait(5) do
        -- Auto-adjust FOV for mobile
        if config.fov > 150 then
            config.fov = 80
        end
    end
end)

print("Mobile AirHub loaded successfully!")
print("Touch and drag title bar to move UI")
print("Use R2 button for aimbot on mobile")
